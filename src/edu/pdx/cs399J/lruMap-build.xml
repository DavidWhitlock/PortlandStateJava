<?xml version="1.0"?>

<!-- Jakarta Ant build file for PSU source code.  You can find out
     more about Ant at: 

                    http://jakarta.apache.org/ant

-->

<project default="usage" basedir=".">

  <!-- Prints usage information on what to build -->
  <target name="usage">
    <echo message=""/>
    <echo message="Building Java source code:"/>
    <echo message=""/>
    <echo message="Targets are:"/>
    <echo message="  compile-src Compiles java source code"/>
    <echo message="  docs        Builds the Javadocs for all this code"/>
    <echo message="  lru-tests   Runs the JUnit test for the LRU map"/>
    <echo message="  clean       Removes all byproducts of building"/>
  </target>

  <!-- Sets up properties used during building -->
  <target name="-props">
    <property environment="myenv"/>

    <!-- Uncomment and set to your login id
    <property name="user.id" value="whitlock"/>
    -->

    <property name="src.dir" value="${basedir}"/>
    <property name="daves.jars.dir" value="/u/whitlock/jars"/>
    <property name="api.docs.dir" value="${basedir}/docs"/>
    <property name="classes.dir" value="${basedir}/classes"/>
    <property name="tests.results.dir" value="${basedir}/test_results"/>

    <property name="cs399J.jar" value="cs399J.jar"/>

    <!-- Sanity check -->
    <fail unless="user.id" 
          message="You must set the user.id property"/>
    <available type="dir" file="${daves.jars.dir}" 
               property="found.daves.jars.dir"/>
    <fail unless="found.daves.jars.dir"
          message="Could not find daves.jars.dir: ${daves.jars.dir}"/>
  </target>

  <!-- Removes byproducts of building -->
  <target name="clean" depends="-props"
          description="Cleans all build artifacts">
    <delete dir="${classes.dir}"/>
    <delete dir="${api.docs.dir}"/>
    <delete dir="${tests.results.dir}"/>
  </target>

  <target name="compile-src" depends="-props" 
          description="Compiles Java source code"> 

    <mkdir dir="${classes.dir}"/>

    <!-- Compile the source code -->
    <javac srcdir="${src.dir}"
           destdir="${classes.dir}"
           includeAntRuntime="false"
           debug="on" source="1.5">
      <include name="edu/pdx/cs399J/${user.id}/**"/>
      <classpath>
        <pathelement location="${daves.jars.dir}/cs399J.jar"/>
      </classpath>
    </javac>

  </target>

  <target name="docs" depends="-props, compile-src"
          description="Builds the Javadocs for all the code">

    <mkdir dir="${api.docs.dir}"/>

    <javadoc packagenames="edu.pdx.cs399J.*"
             destdir="${api.docs.dir}"
             sourcepath="${src.dir}"
             nohelp="yes"
             use="yes"
             splitindex="yes"
             windowtitle="CS399J Docs"
             overview="${src.dir}/overview.html"
    >
      <classpath>
        <pathelement location="${classes.dir}"/>
        <pathelement location="${daves.jars.dir}/cs399J.jar"/>
      </classpath>
      <link href="http://java.sun.com/j2se/1.5/docs/api"/>
      <link href="http://www.junit.org/junit/javadoc/3.7"/>
    </javadoc>
  </target>

  <target name="lru-tests" depends="-props, compile-src"
          description="Runs the JUnit tests for the LRU map">
    <mkdir dir="${tests.results.dir}"/>
    
    <junit haltOnFailure="false" dir="${tests.results.dir}"
           maxmemory="256M" showoutput="true">
      <classpath>
        <pathelement location="${daves.jars.dir}/cs399J.jar"/>
        <pathelement location="${classes.dir}"/>
      </classpath>
      <sysproperty key="LRU_MAP_CLASS_NAME" 
                   value="edu.pdx.cs399J.${user.id}.LRUMap"/>
      <formatter type="plain" usefile="true"/>

      <test fork="yes" todir="${tests.results.dir}"
            name="edu.pdx.cs399J.LRUMapTest"/>
    </junit>
  </target>

</project>